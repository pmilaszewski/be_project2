import requests as r
import shutil
import json

import pickle

PRODUCTS_IDS = [604, 626, 650, 652, 654, 704, 706, 708, 710, 712, 714, 716, 718, 720, 722, 724, 726, 728, 730, 732, 734, 742, 762, 774, 776, 778, 780, 782, 784, 786, 790, 792, 794, 796, 802, 806, 810, 812, 820, 824, 836, 840, 842, 844, 846, 848, 850, 852, 854, 856, 858, 860, 862, 864, 866, 868, 878, 880, 882, 902, 904, 912, 918, 920, 922, 930, 932, 934, 936, 938, 956, 960, 964, 968, 970, 976, 980, 984, 986, 988, 1004, 1016, 1042, 1044, 1052, 1056, 1070, 1076, 1080, 1084, 1086, 1088, 1142, 1162, 1164, 1166, 1186, 1190, 1192, 1198, 1220, 1240, 1242, 1260, 1272, 1274, 1278, 1288, 1292, 1312, 1316, 1320, 1328, 1330, 1334, 1336, 1344, 1346, 1348, 1358, 1368, 1370, 1374, 1380, 1396, 1402, 1408, 1412, 1414, 1420, 1424, 1436, 1438, 1444, 1452, 1454, 1458, 1474, 1480, 1486, 1494, 1502, 1506, 1510, 1512, 1544, 1546, 2104, 2108, 2122, 2124, 2150, 2160, 2162, 2164, 2166, 2168, 2172, 2174, 2176, 2180, 2182, 2184, 2204, 2206, 2216, 2220, 2238, 2240, 2242, 2244, 2254, 2256, 2266, 2268, 2276, 2278, 2280, 2282, 2284, 2286, 2288, 2290, 2302, 2306, 2308, 2310, 2314, 2316, 2318, 2320, 2322, 2324, 2326, 2328, 2330, 2332, 2340, 2346, 2348, 2360, 2372, 2374, 2382, 2386, 2388, 2392, 2394, 2400, 2402, 2404, 2410, 2418, 2422, 2434, 2436, 2438, 2440, 2442, 2454, 2456, 2458, 2460, 2462, 2464, 2470, 2476, 2482, 2484, 2486, 2508, 2510, 2512, 2514, 2516, 2518, 2520, 2522, 2524, 2525, 2527, 2529, 2533, 2537, 2539, 2541, 2543, 2545, 2547, 2549, 2553, 2555, 2557, 2559, 2561, 2563, 2565, 2569, 2605, 2607, 2609, 2611, 2613, 2615, 2617, 2619, 2625, 2643, 2645, 2647, 2651, 2653, 2655, 2659, 2661, 2665, 2669, 2671, 2673, 2681, 2685, 2689, 2691, 2701, 2715, 2717, 2719, 2721, 2723, 2725, 2727, 2729, 2731, 2733, 2735, 2737, 2739, 2741, 2743, 2745, 2747, 2749, 2751, 2753, 2775, 2783, 2787, 2792, 2794, 2796, 2798, 2800, 2802, 2804, 2806, 2808, 2810, 2812, 2814, 2819, 2821, 2829, 2869, 2875, 2877, 2879, 2881, 2883, 2885, 2891, 2893, 2895, 2897, 2899, 2911, 2913, 2919, 2923, 2927, 2939, 2941, 2951, 2953, 2965, 2967, 2969, 2971, 2973, 2975, 2977, 2985, 2987, 2997, 2999, 3001, 3003, 3005, 3007, 3009, 3011, 3013, 3019, 3029, 3031, 3033, 3035, 3037, 3039, 3041, 3043, 3045, 3047, 3059, 3063, 3065, 3067, 3069, 3083, 3085, 3087, 3091, 3093, 3095, 3097, 3101, 3115, 3117, 3119, 3121, 3123, 3125, 3127, 3129, 3131, 3135, 3137, 3139, 3141, 3143, 3145, 3147, 3149, 3157, 3161, 3165, 3167, 3169, 3171, 3173, 3175, 3179, 3181, 3191, 3197, 3201, 3203, 3207, 3209, 3213, 3219, 3221, 3225, 3227, 3229, 3231, 3233, 3237, 3241, 3245, 3253, 3271, 3275, 3279, 3281, 3293, 3295, 3301, 3303, 3305, 3307, 3313, 3315, 3317, 3319, 3325, 3327, 3329, 3331, 3345, 3347, 3355, 3357, 3361, 3363, 3377, 3379, 3381, 3385, 3387, 3395, 3397, 3401, 3403, 3405, 3407, 3409, 3411, 3413, 3415, 3419, 3423, 3425, 3427, 3429, 3431, 3433, 3435, 3439, 3441, 3443, 3445, 3453, 3455, 3457, 3459, 3461, 3465, 3473, 3475, 3477, 3481, 3483, 3487, 3533, 3546, 3548, 3550, 3552, 3554, 3570, 3572, 3604, 3606, 3608, 3646, 3648, 3656, 3674, 3676, 3704, 3706, 3708, 3710, 3714, 3716, 3724, 3726, 3732, 3734, 3736, 3740, 3742, 3746, 3748, 3754, 3756, 3758, 3760, 3766, 3770, 3774, 3788, 3790, 3792, 3794, 3796, 3798, 3800, 3802, 3804, 3806, 3808, 3810, 3812, 3814, 3816, 3820, 3822, 3824, 3826, 3842, 3846, 3848, 3852, 3854, 3856, 3858, 3860, 3864, 3884, 3886, 3888, 3892, 3896, 3898, 3904, 3906, 3908, 3910, 3912, 3914, 3916, 3918, 3920, 3922, 3924, 3928, 3930, 3932, 3934, 3936, 3938, 3940, 3942, 3944, 3946, 3948, 3950, 3954, 3956, 3958, 3960, 3962, 3964, 3966, 3968, 3970, 3972, 3974, 3982, 3990, 4002, 4004, 4006, 4008, 4010, 4012, 4014, 4016, 4018, 4020, 4030, 4040, 4056, 4058, 4060, 4062, 4064, 4066, 4068, 4070, 4078, 4104, 4106, 4108, 4110, 4112, 4116, 4118, 4120, 4122, 4124, 4128, 4130, 4142, 4144, 4148, 4150, 4152, 4154, 4156, 4166, 4172, 4174, 4176, 4190, 4192, 4196, 4198, 4200, 4206, 4208, 4210, 4230, 4234, 4238, 4242, 4246, 4248, 4250, 4252, 4254, 4256, 4258, 4260, 4262, 4264, 4266, 4268, 4278, 4280, 4284, 4300, 4330, 4354, 4356, 4358, 4360, 4362, 4364, 4366, 4368, 4370, 4372, 4374, 4376, 4378, 4380, 4382, 4384, 4386, 4390, 4394, 4396, 4398, 4404, 4412, 4418, 4420, 4422, 4446, 4450, 4452, 4454, 4456, 4458, 4460, 4462, 4464, 4466, 4468, 4470, 4472, 4474, 4476, 4478, 4486, 4488, 4490, 4492, 4494, 4496, 4498, 4500, 4506, 4508, 4510, 4512, 4514, 4516, 4518, 4520, 4524, 4526, 4530, 4532, 4534, 4536, 4538, 4540, 4542, 4544, 4548, 4550, 4560, 4562, 4564, 4570, 4572, 4584, 4590, 4592, 4596, 4598, 4600, 4606, 4610, 4612, 4614, 4616, 4618, 4620, 4622, 4624, 4626, 4628, 4630, 4632, 4636, 4638, 4640, 4642, 4644, 4646, 4654, 4658, 4660, 4662, 4666, 4668, 4670, 4674, 4676, 4678, 4680, 4682, 4684, 4686, 4688, 4694, 4696, 4698, 4700, 4702, 4704, 4706, 4708, 4710, 4712, 4714, 4716, 4718, 4720, 4734, 4750, 4752, 4754, 4756, 4758, 4760, 4762, 4764, 4766, 4768, 4770, 4772, 4790, 4798, 4800, 4802, 4804, 4806, 4808, 4810, 4812, 4814, 4816, 4818, 4820, 4822, 4824, 4826, 4828, 4830, 4832, 4834, 4836, 4838, 4840, 4842, 4844, 4846, 4848, 4850, 4852, 4854, 4856, 4858, 4860, 4862, 4864, 4866, 4868, 4870, 4872, 4874, 4876, 4878, 4880, 4882, 4884, 4886, 4888, 4890, 4896, 4900, 4902, 4904, 4906, 4908, 4910, 4912, 4914, 4916, 4918, 4920, 4922, 4924, 4926, 4928, 4930, 4932, 4934, 4936, 4938, 4940, 4942, 4944, 4946, 4948, 4950, 4952, 4954, 4956, 4958, 4960, 4962, 4964, 4966, 4968, 4970, 4972, 4974, 4976, 4978, 4980, 4982, 4984, 4986, 4988, 4990, 4992, 4994, 4996, 4998, 5000, 5002, 5004, 5006, 5008, 5010, 5012, 5014, 5016, 5018, 5020, 5022, 5024, 5026, 5028, 5030, 5032, 5034, 5036, 5038, 5040, 5042, 5044, 5046, 5048, 5050, 5052, 5054, 5056, 5058, 5060, 5062, 5064, 5066, 5068, 5070, 5072, 5074, 5090, 5094, 5096, 5100, 5102, 5104, 5106, 5108, 5110, 5112, 5114, 5116, 5118, 5120, 5122, 5124, 5126, 5128, 5130, 5132, 5134, 5136, 5138, 5140, 5142, 5144, 5146, 5148, 5150, 5152, 5154, 5156, 5158, 5160, 5162, 5164, 5166, 5168, 5170, 5172, 5174, 5176, 5178, 5180, 5182, 5184, 5186, 5188, 5190, 5192, 5198, 5202, 5204, 5206, 5208, 5210, 5212, 5218, 5220, 5226, 5228, 5230, 5232, 5234, 5236, 5238, 5240, 5242, 5244, 5246, 5248, 5250, 5252, 5254, 5256, 5258, 5260, 5262, 5264, 5266, 5270, 5272, 5274, 5276, 5278, 5280, 5282, 5284, 5286, 5288, 5290, 5292, 5294, 5296, 5298, 5300, 5302, 5304, 5306, 5308, 5310, 5314, 5322, 5324, 5326, 5328, 5330, 5332, 5334, 5336, 5340, 5342, 5348, 5380, 5382, 5384, 5386, 5388, 5390, 5392, 5394, 5396, 5398, 5400, 5402, 5404, 5406, 5408, 5410, 5412, 5414, 5416, 5418, 5420, 5422, 5424, 5426, 5428, 5430, 5432, 5434, 5436, 5438, 5440, 5442, 5444, 5446, 5448, 5450, 5452, 5454, 5456, 5458, 5460, 5462, 5464, 5466, 5468, 5470, 5472, 5474, 5476, 5478, 5480, 5482, 5484, 5486, 5488, 5490, 5492, 5494, 5496, 5498, 5500, 5502, 5504, 5506, 5508, 5510, 5512, 5514, 5522, 5524, 5526, 5528, 5530, 5532, 5534, 5536, 5538, 5540, 5542, 5544, 5546, 5548, 5550, 5560, 5562, 5564, 5566, 5568, 5570, 5572, 5574, 5576, 5578, 5580, 5582, 5584, 5586, 5588, 5590, 5592, 5594, 5596, 5598, 5600, 5602, 5604, 5606, 5608, 5610, 5612, 5614, 5616, 5618, 5620, 5622, 5624, 5626, 5628, 5630, 5632, 5634, 5636, 5638, 5640, 5642, 5644, 5646, 5648, 5650, 5652, 5654, 5656, 5658, 5660, 5662, 5664, 5666, 5668, 5670, 5672, 5674, 5676, 5678, 5680, 5682, 5683, 5684, 5685, 5686, 5687, 5688, 5689, 5690, 5691, 5692, 5693, 5694, 5695, 5696, 5697, 5698, 5699, 5700, 5701, 5702, 5703, 5704, 5705, 5706, 5707, 5708, 5709, 5710, 5711, 5712, 5713, 5714, 5715, 5716, 5717, 5718, 5719, 5720, 5721, 5722, 5723, 5724, 5725, 5726, 5727, 5728, 5729, 5730, 5731, 5732, 5733, 5734, 5735, 5736, 5737, 5738, 5739, 5740, 5741, 5742, 5743, 5744, 5745, 5746, 5747, 5748, 5749, 5750, 5751, 5752, 5753, 5754, 5755, 5756, 5757, 5758, 5759, 5760, 5761, 5762, 5763, 5764, 5765, 5766, 5767, 5768, 5769, 5770, 5771, 5772, 5773, 5774, 5775, 5776, 5777, 5778, 5779, 5780, 5781, 5782, 5783, 5784, 5785, 5786, 5787, 5788, 5789, 5790, 5791, 5792, 5793, 5794, 5795, 5796, 5797, 5798, 5799, 5800, 5801, 5802, 5803, 5804, 5805, 5806, 5807, 5808, 5809, 5810, 5811, 5812, 5813, 5814, 5815, 5816, 5817, 5818, 5819, 5820, 5821, 5822, 5823, 5824, 5825, 5826, 5827, 5828, 5829, 5830, 5831, 5832, 5833, 5834, 5835, 5837, 5838, 5839, 5840, 5841, 5842, 5844, 5845, 5846, 5847, 5848]

def get_number_of_product_pages():
    try:
        response = r.get('https://sklep.argon-lampy.pl/webapi/front/pl_PL/products/PLN/list?&fbclid=IwAR0dwJAkdIe0DQelQRbuL1RKKQVSYE8n492Ao3Fgw3jasabYHrs8zaMHnBY')
        json_dict = json.loads(response.content.decode("utf-8"))
        return int(json_dict["pages"])
    except (IndexError, ValueError):
        raise ValueError


def get_products_ids_from_page(page_json_dict):
    page_ids_list = []
    for product in page_json_dict:
        try:
            page_ids_list.append(int(product['id']))
        except (IndexError, ValueError):
            pass
    return page_ids_list



def get_all_products_ids(number_of_pages):
    products_ids_list = []
    for i in range(1, number_of_pages + 1):
        response = r.get(f'https://sklep.argon-lampy.pl/webapi/front/pl_PL/products/PLN/list?page={i}&fbclid=IwAR0dwJAkdIe0DQelQRbuL1RKKQVSYE8n492Ao3Fgw3jasabYHrs8zaMHnBY')
        json_dict = json.loads(response.content.decode("utf-8"))
        products_ids_list += get_products_ids_from_page(json_dict['list'])
    return products_ids_list


def get_product(product_id):
    response = r.get(f'https://sklep.argon-lampy.pl/webapi/front/pl_PL/products/PLN/{product_id}?fbclid=IwAR3zBX7kqw7Imid5r6jGvQ9BxZAFDxiq7Tuk736KLMatNsIDLWJFq9OwZ0w')
    if(response.status_code == 200):
        return json.loads(response.content.decode("utf-8"))


def get_products(products_ids):
    products_list = []
    for _id in PRODUCTS_IDS:
        products_list.append(get_product(_id))
    return products_list


def save_to_file(products_list):
    with open("products.json", 'wb') as f:
        pickle.dump(products_list, f)


def get_image(image_path):
    image_id = image_path.split(".")[0]
    image_type = image_path.split(".")[1]

    while True:
        try:
            response = r.get(f"https://sklep.argon-lampy.pl/environment/cache/images/500_500_productGfx_{image_id}/*.{image_type}", stream = True)
            if response.status_code == 200:
                with open(f"img/{image_path}",'wb') as f:
                    shutil.copyfileobj(response.raw, f)
            else:
                print("Image error")
            return
        except r.exceptions.SSLError:
            pass

def get_products_images(products_list):
    for idx, product in enumerate(products_list):
        print(idx)
        try:
            for file_name in product['images_filename']:
                get_image(file_name)
        except (IndexError, KeyError):
            print("No images")


def main():
    products_list = get_products(get_all_products_ids(get_number_of_product_pages())
    save_to_file(products_list)
    get_products_images(products_list)


if __name__ == "__main__":
    main()
